AWSTemplateFormatVersion: "2010-09-09"
Description: CloudWatch Dashboard for RunsOn stack monitoring

Parameters:
  StackName:
    Type: String
    Description: Name of the parent RunsOn stack
    
  LogGroupName:
    Type: String
    Description: Log group name from the parent stack
    
  DashboardName:
    Type: String
    Description: Name for the CloudWatch dashboard
    Default: RunsOn-Operations-Dashboard
    
  QueueName:
    Type: String
    Description: Name of the SQS queue to monitor

Resources:
  RunsOnDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Ref DashboardName
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${QueueName}" ]
                ],
                "period": 300,
                "stat": "Maximum",
                "region": "${AWS::Region}",
                "title": "Jobs Currently Queued",
                "view": "timeSeries"
              }
            },
            {
              "type": "log",
              "x": 8,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter message like /ðŸŽ‰ Runner scheduled successfully/\n| stats count() as RunnersScheduled",
                "region": "${AWS::Region}",
                "title": "Total Runners Scheduled (Current Period)",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 16,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter message like /ðŸŽ‰ Runner scheduled successfully/\n| stats count() as RunnersScheduled by bin(5m)\n| sort bin",
                "region": "${AWS::Region}",
                "title": "Runners Scheduled over time (5min intervals)",
                "view": "timeSeries"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter message like /Posted .* of workflow usage/\n| stats count() as Count by job_conclusion\n| sort Count desc",
                "region": "${AWS::Region}",
                "title": "Completed Jobs by Conclusion",
                "view": "stackedArea"
              }
            },
            {
              "type": "log",
              "x": 8,
              "y": 6,
              "width": 16,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter metric_type = \"rate_limiter\" and limiter in [\"ec2_read\", \"ec2_run\", \"ec2_terminate\", \"ec2_mutating\"]\n| stats avg(tokens) as avg_tokens by limiter, bin(5m)\n| sort bin",
                "region": "${AWS::Region}",
                "title": "EC2 Rate Limiters (tokens remaining)",
                "view": "timeSeries"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter metric_type = \"rate_limiter\" and limiter = \"github\"\n| stats avg(tokens) as avg_tokens, avg(burst) as avg_burst by bin(5m)\n| sort bin",
                "region": "${AWS::Region}",
                "title": "GitHub API Rate Limiter (tokens remaining)",
                "view": "timeSeries"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter level = \"error\"\n| fields @timestamp, message\n| sort @timestamp desc\n| limit 50",
                "region": "${AWS::Region}",
                "title": "Recent Error Messages (Latest 50)",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 18,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter metric_type = \"jobs_summary\"\n| stats latest(queued) as queued, latest(scheduled) as scheduled, latest(in_progress) as in_progress, latest(completed) as completed, latest(interrupted) as interrupted by bin(5m)\n| sort bin",
                "region": "${AWS::Region}",
                "title": "Job Status Summary",
                "view": "timeSeries"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 18,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter metric_type = \"pool_instances\"\n| stats latest(warming_up) as warming_up, latest(ready) as ready, latest(ready_to_stop) as ready_to_stop, latest(detached) as detached, latest(error) as error by pool_name, bin(5m)\n| sort bin",
                "region": "${AWS::Region}",
                "title": "Pool Instances by State",
                "view": "timeSeries"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 24,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter metric_type = \"webhook_redelivery_summary\" and ispresent(@message)\n| stats sum(deliveries_redelivered) as TotalRedelivered, sum(deliveries_failed) as TotalFailed, sum(deliveries_scanned) as TotalScanned, sum(deliveries_ignored) as TotalIgnored by bin(5m)\n| sort @timestamp desc",
                "region": "${AWS::Region}",
                "title": "Webhook Redeliveries (Last 24h)",
                "view": "table",
                "stacked": false
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 24,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter metric_type = \"webhook_redelivery_summary\" and ispresent(@message)\n| stats sum(deliveries_redelivered) as Redelivered by bin(5m)\n| sort @timestamp",
                "region": "${AWS::Region}",
                "title": "Webhook Redeliveries Over Time",
                "view": "timeSeries",
                "stacked": false
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 30,
              "width": 24,
              "height": 6,
              "properties": {
                "query": "SOURCE '${LogGroupName}'\n| filter metric_type = \"webhook_redelivery_success\" and ispresent(@message)\n| fields @timestamp, delivery_id, event, action, original_status_code\n| sort @timestamp desc\n| limit 20",
                "region": "${AWS::Region}",
                "title": "Recent Webhook Redeliveries",
                "view": "table"
              }
            }
          ]
        }

Outputs:
  DashboardURL:
    Description: URL to the CloudWatch Dashboard
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${DashboardName}"
    
  DashboardName:
    Description: Name of the created dashboard
    Value: !Ref DashboardName